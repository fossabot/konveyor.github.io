<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.105.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Advanced migration options - Documentation for Konveyor projects</title><link href=/css/nucleus.css rel=stylesheet><link href=/css/fontawesome-all.min.css rel=stylesheet><link href=/css/hybrid.css rel=stylesheet><link href=/css/featherlight.min.css rel=stylesheet><link href=/css/perfect-scrollbar.min.css rel=stylesheet><link href=/css/auto-complete.css rel=stylesheet><link href=/css/atom-one-dark-reasonable.css rel=stylesheet><link href=/css/theme.css rel=stylesheet><link href=/css/tabs.css rel=stylesheet><link href=/css/hugo-theme.css rel=stylesheet><link href=/css/theme-konveyor.css rel=stylesheet><link href=/css/foo.css rel=stylesheet><link href=/css/bar.css rel=stylesheet><script src=/js/jquery-3.3.1.min.js></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script>var dataLayer=window.dataLayer=window.dataLayer||[];dataLayer.push({page:"Advanced migration options",fileUniqID:"3bc83bef0c363e5b9a92bd1db1ca6e01"})</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-TKPDMS3")</script></head><body data-url=/forklift/migratingvms/advancedmigrate/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><img src=/images/konveyor_logo.png></img></a>
<a href=https://github.com/konveyor/konveyor.github.io>Documentation source code</a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js></script>
<script type=text/javascript src=/js/auto-complete.js></script>
<script type=text/javascript>var baseurl="http://konveyor.github.io/"</script><script type=text/javascript src=/js/search.js></script></div><div class=highlightable><ul class=topics><li data-nav-id=/crane/ title=Crane class=dd-item><a href=/crane/><b>1 </b>Crane</a><ul><li data-nav-id=/crane/overview/ title=Overview class=dd-item><a href=/crane/overview/>Overview</a></li><li data-nav-id=/crane/tutorials/ title=Tutorials class=dd-item><a href=/crane/tutorials/>Tutorials</a><ul><li data-nav-id=/crane/tutorials/statelessappmirror/ title="Stateless application mirror" class=dd-item><a href=/crane/tutorials/statelessappmirror/>Stateless application mirror</a></li><li data-nav-id=/crane/tutorials/migratek8cluster/ title="Migrating a Kubernetes cluster" class=dd-item><a href=/crane/tutorials/migratek8cluster/>Migrating a Kubernetes cluster</a></li></ul></li><li data-nav-id=/crane/tools/ title=Tools class=dd-item><a href=/crane/tools/>Tools</a><ul><li data-nav-id=/crane/tools/gitopsintegration/ title="Integrating GitOps" class=dd-item><a href=/crane/tools/gitopsintegration/>Integrating GitOps</a></li><li data-nav-id=/crane/tools/customplugins/ title="Developing custom plugins" class=dd-item><a href=/crane/tools/customplugins/>Developing custom plugins</a></li><li data-nav-id=/crane/tools/tunnelapi/ title="Tunnel API" class=dd-item><a href=/crane/tools/tunnelapi/>Tunnel API</a></li><li data-nav-id=/crane/tools/pluginmanager/ title="Plugin Manager" class=dd-item><a href=/crane/tools/pluginmanager/>Plugin Manager</a></li></ul></li><li data-nav-id=/crane/usingcrane/ title="Using Crane" class=dd-item><a href=/crane/usingcrane/>Using Crane</a><ul><li data-nav-id=/crane/usingcrane/step1export/ title="Step One: Export Resources" class=dd-item><a href=/crane/usingcrane/step1export/>Step One: Export Resources</a></li><li data-nav-id=/crane/usingcrane/step2transform/ title="Step Two: Transform Exports" class=dd-item><a href=/crane/usingcrane/step2transform/>Step Two: Transform Exports</a></li><li data-nav-id=/crane/usingcrane/step3apply/ title="Step Three: Apply Patches" class=dd-item><a href=/crane/usingcrane/step3apply/>Step Three: Apply Patches</a></li></ul></li><li data-nav-id=/crane/installation/ title="Installing Crane" class=dd-item><a href=/crane/installation/>Installing Crane</a></li></ul></li><li data-nav-id=/forklift/ title=Forklift class="dd-item
parent"><a href=/forklift/><b>2 </b>Forklift</a><ul><li data-nav-id=/forklift/overview/ title=Overview class=dd-item><a href=/forklift/overview/>Overview</a></li><li data-nav-id=/forklift/migratingvms/ title="Migrating virtual machines" class="dd-item
parent"><a href=/forklift/migratingvms/>Migrating virtual machines</a><ul><li data-nav-id=/forklift/migratingvms/migrateoptions/ title="Migration plan options" class=dd-item><a href=/forklift/migratingvms/migrateoptions/>Migration plan options</a></li><li data-nav-id=/forklift/migratingvms/migratecli/ title="Migrating virtual machines using the command line" class=dd-item><a href=/forklift/migratingvms/migratecli/>Migrating virtual machines using the command line</a></li><li data-nav-id=/forklift/migratingvms/migrateweb/ title="Migrating virtual machines using the web console" class=dd-item><a href=/forklift/migratingvms/migrateweb/>Migrating virtual machines using the web console</a></li><li data-nav-id=/forklift/migratingvms/cancelmigrate/ title="Canceling a migration" class=dd-item><a href=/forklift/migratingvms/cancelmigrate/>Canceling a migration</a></li><li data-nav-id=/forklift/migratingvms/advancedmigrate/ title="Advanced migration options" class="dd-item active"><a href=/forklift/migratingvms/advancedmigrate/>Advanced migration options</a></li></ul></li><li data-nav-id=/forklift/installingforklift/ title="Installing Forklift" class=dd-item><a href=/forklift/installingforklift/>Installing Forklift</a><ul><li data-nav-id=/forklift/installingforklift/upgrade/ title="Upgrading Forklift" class=dd-item><a href=/forklift/installingforklift/upgrade/>Upgrading Forklift</a></li><li data-nav-id=/forklift/installingforklift/uninstall/ title="Uninstalling Forklift" class=dd-item><a href=/forklift/installingforklift/uninstall/>Uninstalling Forklift</a></li><li data-nav-id=/forklift/installingforklift/installation/ title="Installing the Forklift Operator" class=dd-item><a href=/forklift/installingforklift/installation/>Installing the Forklift Operator</a></li><li data-nav-id=/forklift/installingforklift/prereqs/ title=Prerequisites class=dd-item><a href=/forklift/installingforklift/prereqs/>Prerequisites</a></li></ul></li></ul></li><li data-nav-id=/move2kube/ title=Move2Kube class=dd-item><a href=/move2kube/><b>3 </b>Move2Kube</a><ul><li data-nav-id=/move2kube/overview/ title=Overview class=dd-item><a href=/move2kube/overview/>Overview</a></li><li data-nav-id=/move2kube/concepts/ title=Concepts class=dd-item><a href=/move2kube/concepts/>Concepts</a></li><li data-nav-id=/move2kube/installation/ title=Installation class=dd-item><a href=/move2kube/installation/>Installation</a><ul><li data-nav-id=/move2kube/installation/installweb/ title="Web Interface" class=dd-item><a href=/move2kube/installation/installweb/>Web Interface</a></li><li data-nav-id=/move2kube/installation/installcli/ title="Command line tool" class=dd-item><a href=/move2kube/installation/installcli/>Command line tool</a></li></ul></li><li data-nav-id=/move2kube/commands/ title=Commands class=dd-item><a href=/move2kube/commands/>Commands</a></li><li data-nav-id=/move2kube/transformers/ title=Transformers class=dd-item><a href=/move2kube/transformers/>Transformers</a></li><li data-nav-id=/move2kube/tutorials/ title=Tutorials class=dd-item><a href=/move2kube/tutorials/>Tutorials</a><ul><li data-nav-id=/move2kube/tutorials/usingcli/ title="Using Move2Kube CLI" class=dd-item><a href=/move2kube/tutorials/usingcli/>Using Move2Kube CLI</a></li><li data-nav-id=/move2kube/tutorials/usingui/ title="Using Move2Kube UI" class=dd-item><a href=/move2kube/tutorials/usingui/>Using Move2Kube UI</a></li><li data-nav-id=/move2kube/tutorials/cfappstok8/ title="Migrating Enterprise Scale Cloud Foundry Apps to Kubernetes" class=dd-item><a href=/move2kube/tutorials/cfappstok8/>Migrating Enterprise Scale Cloud Foundry Apps to Kubernetes</a><ul><li data-nav-id=/move2kube/tutorials/cfappstok8/1collect/ title="1. Collect" class=dd-item><a href=/move2kube/tutorials/cfappstok8/1collect/>1. Collect</a></li><li data-nav-id=/move2kube/tutorials/cfappstok8/2plan/ title="2. Plan" class=dd-item><a href=/move2kube/tutorials/cfappstok8/2plan/>2. Plan</a></li><li data-nav-id=/move2kube/tutorials/cfappstok8/3transform/ title="3. Transform" class=dd-item><a href=/move2kube/tutorials/cfappstok8/3transform/>3. Transform</a></li></ul></li><li data-nav-id=/move2kube/tutorials/customizeoutput/ title="Customizing the output" class=dd-item><a href=/move2kube/tutorials/customizeoutput/>Customizing the output</a><ul><li data-nav-id=/move2kube/tutorials/customizeoutput/addcustfiledir/ title="Add custom files and directories in custom locations" class=dd-item><a href=/move2kube/tutorials/customizeoutput/addcustfiledir/>Add custom files and directories in custom locations</a></li><li data-nav-id=/move2kube/tutorials/customizeoutput/paramcustomfieldshelm/ title="Parameterizing custom fields in Helm Chart, Kustomize, OC templates" class=dd-item><a href=/move2kube/tutorials/customizeoutput/paramcustomfieldshelm/>Parameterizing custom fields in Helm Chart, Kustomize, OC templates</a></li><li data-nav-id=/move2kube/tutorials/customizeoutput/customannotationsyaml/ title="Add custom annotations to Kubernetes YAMLs" class=dd-item><a href=/move2kube/tutorials/customizeoutput/customannotationsyaml/>Add custom annotations to Kubernetes YAMLs</a></li><li data-nav-id=/move2kube/tutorials/customizeoutput/customgendockerfile/ title="Customize generated Dockerfile and built-in transformer behavior" class=dd-item><a href=/move2kube/tutorials/customizeoutput/customgendockerfile/>Customize generated Dockerfile and built-in transformer behavior</a></li></ul></li><li data-nav-id=/move2kube/tutorials/customkubeyaml/ title="Customize Kubernetes YAMLs to target specific clusters" class=dd-item><a href=/move2kube/tutorials/customkubeyaml/>Customize Kubernetes YAMLs to target specific clusters</a></li><li data-nav-id=/move2kube/tutorials/createhelmchartskustomize/ title="Create Helm-charts, Kustomize overlays from Kubernetes Yamls" class=dd-item><a href=/move2kube/tutorials/createhelmchartskustomize/>Create Helm-charts, Kustomize overlays from Kubernetes Yamls</a></li><li data-nav-id=/move2kube/tutorials/createwincontainersnet/ title="Create and deploy Windows .NET containers" class=dd-item><a href=/move2kube/tutorials/createwincontainersnet/>Create and deploy Windows .NET containers</a></li><li data-nav-id=/move2kube/tutorials/migratedeploynetcore/ title="Migrate and deploy .NET Core applications to Kubernetes" class=dd-item><a href=/move2kube/tutorials/migratedeploynetcore/>Migrate and deploy .NET Core applications to Kubernetes</a></li><li data-nav-id=/move2kube/tutorials/migratedockercomposekube/ title="Migrate from Docker Compose to Kubernetes" class=dd-item><a href=/move2kube/tutorials/migratedockercomposekube/>Migrate from Docker Compose to Kubernetes</a></li><li data-nav-id=/move2kube/tutorials/migratedeploycfapps/ title="Migrate and deploy Cloud Foundry applications to Kubernetes" class=dd-item><a href=/move2kube/tutorials/migratedeploycfapps/>Migrate and deploy Cloud Foundry applications to Kubernetes</a></li><li data-nav-id=/move2kube/tutorials/runnoninteractively/ title="Run transforms non-interactively" class=dd-item><a href=/move2kube/tutorials/runnoninteractively/>Run transforms non-interactively</a></li></ul></li></ul></li><li data-nav-id=/tackle/ title="Tackle 1.0 & 2.0" class=dd-item><a href=/tackle/><b>4 </b>Tackle 1.0 & 2.0</a><ul><li data-nav-id=/tackle/tackle1/ title="Tackle 1.0" class=dd-item><a href=/tackle/tackle1/><b>4.1 </b>Tackle 1.0</a><ul><li data-nav-id=/tackle/tackle1/upgrade/ title="Upgrading Tackle" class=dd-item><a href=/tackle/tackle1/upgrade/>Upgrading Tackle</a></li><li data-nav-id=/tackle/tackle1/webconsolesvcs/ title="Web Console Services" class=dd-item><a href=/tackle/tackle1/webconsolesvcs/>Web Console Services</a></li><li data-nav-id=/tackle/tackle1/manageusers/ title="Managing users and credentials" class=dd-item><a href=/tackle/tackle1/manageusers/>Managing users and credentials</a></li><li data-nav-id=/tackle/tackle1/manageassess/ title="Managing assessments" class=dd-item><a href=/tackle/tackle1/manageassess/>Managing assessments</a></li><li data-nav-id=/tackle/tackle1/manageapps/ title="Managing applications" class=dd-item><a href=/tackle/tackle1/manageapps/>Managing applications</a></li><li data-nav-id=/tackle/tackle1/additionaltools/ title="Additional tools" class=dd-item><a href=/tackle/tackle1/additionaltools/>Additional tools</a></li></ul></li><li data-nav-id=/tackle/tackle2/ title="Tackle 2.0" class=dd-item><a href=/tackle/tackle2/><b>4.2 </b>Tackle 2.0</a><ul><li data-nav-id=/tackle/tackle2/admintasks/ title="Administrator view tasks" class=dd-item><a href=/tackle/tackle2/admintasks/>Administrator view tasks</a></li><li data-nav-id=/tackle/tackle2/views/ title="Tackle 2.0 Views" class=dd-item><a href=/tackle/tackle2/views/>Tackle 2.0 Views</a></li><li data-nav-id=/tackle/tackle2/instances/ title="Seeding Instances" class=dd-item><a href=/tackle/tackle2/instances/>Seeding Instances</a></li><li data-nav-id=/tackle/tackle2/assessanalyze/ title="Assessing and analyzing applications" class=dd-item><a href=/tackle/tackle2/assessanalyze/>Assessing and analyzing applications</a></li><li data-nav-id=/tackle/tackle2/addapps/ title="Adding applications" class=dd-item><a href=/tackle/tackle2/addapps/>Adding applications</a></li></ul></li><li data-nav-id=/tackle/overview/ title=Overview class=dd-item><a href=/tackle/overview/>Overview</a></li><li data-nav-id=/tackle/upgradeto2/ title="Upgrading from 1.2 to 2.0" class=dd-item><a href=/tackle/upgradeto2/>Upgrading from 1.2 to 2.0</a></li><li data-nav-id=/tackle/installation/ title="Installing Tackle 2.0" class=dd-item><a href=/tackle/installation/>Installing Tackle 2.0</a></li><li data-nav-id=/tackle/installation1/ title="Installing Tackle 1.0" class=dd-item><a href=/tackle/installation1/>Installing Tackle 1.0</a></li></ul></li></ul><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Advanced migration options</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#changing-precopy-intervals-for-warm-migration>Changing precopy intervals for warm migration</a></li><li><a href=#creating-custom-rules-for-the-validation-service>Creating custom rules for the Validation service</a><ul><li><a href=#about-rego-files>About Rego files</a></li></ul></li><li><a href=#checking-the-default-validation-rules>Checking the default validation rules</a></li><li><a href=#retrieving-the-inventory-service-json>Retrieving the Inventory service JSON</a></li><li><a href=#creating-a-validation-rule>Creating a validation rule</a><ul><li><a href=#validation-rule-example>Validation rule example</a></li></ul></li><li><a href=#updating-the-inventory-rules-version>Updating the inventory rules version</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Advanced migration options</h1><h2 id=changing-precopy-intervals-for-warm-migration>Changing precopy intervals for warm migration</h2><p>Follow the steps below to change the snapshot interval by patching the ForkliftController custom resource (CR).</p><p><strong>Procedure</strong></p><ul><li>Patch the ForkliftController CR:</li></ul><pre tabindex=0><code>$ kubectl patch forkliftcontroller/&lt;forklift-controller&gt; -n konveyor-forklift -p &#39;{&#34;spec&#34;: {&#34;controller_precopy_interval&#34;: &lt;60&gt;}}&#39; --type=merge (1)
</code></pre><p>The explanation below refers to the callout in the sample code above.</p><ul><li>(1) Specify the precopy interval in minutes. The default value is 60.</li></ul><blockquote><p><strong>Note:</strong> The forklift-controller pod does not need to be restarted.</p></blockquote><h2 id=creating-custom-rules-for-the-validation-service>Creating custom rules for the Validation service</h2><p>The Validation service uses Open Policy Agent (OPA) policy rules to check the suitability of each virtual machine (VM) for migration. The Validation service generates a list of concerns for each VM, which are stored in the Provider Inventory service as VM attributes. The web console displays the concerns for each VM in the provider inventory.</p><p>Custom rules to extend the default ruleset of the Validation service can be created. For example, create a rule that checks whether a VM has multiple disks.</p><h3 id=about-rego-files>About Rego files</h3><p>Validation rules are written in Rego, the Open Policy Agent (OPA) native query language. The rules are stored as .rego files in the /usr/share/opa/policies/io/konveyor/forklift/ directory of the Validation pod.</p><p>Each validation rule is defined in a separate .rego file and tests for a specific condition. If the condition evaluates as true, the rule adds a {“category”, “label”, “assessment”} hash to the concerns. The concerns content is added to the concerns key in the inventory record of the VM. The web console displays the content of the concerns key for each VM in the provider inventory.</p><p>The following .rego file example checks for distributed resource scheduling enabled in the cluster of a VMware VM:</p><p>drs_enabled.rego example:</p><pre tabindex=0><code>package io.konveyor.forklift.vmware (1)

has_drs_enabled {
    input.host.cluster.drsEnabled (2)
}

concerns[flag] {
    has_drs_enabled
    flag := {
        &#34;category&#34;: &#34;Information&#34;,
        &#34;label&#34;: &#34;VM running in a DRS-enabled cluster&#34;,
        &#34;assessment&#34;: &#34;Distributed resource scheduling is not currently supported by OpenShift Virtualization. The VM can be migrated but it will not have this feature in the target environment.&#34;
    }
}
</code></pre><p>The explanations below refer to the callouts in the sample code above.</p><ul><li>(1) Each validation rule is defined within a package. The package namespaces are io.konveyor.forklift.vmware for VMware and io.konveyor.forklift.ovirt for oVirt.</li><li>(2) Query parameters are based on the input key of the Validation service JSON.</li></ul><h2 id=checking-the-default-validation-rules>Checking the default validation rules</h2><p>Before creating a custom rule, follow the steps below to check the default rules of the Validation service to prevent creating a rule that redefines an existing default value.</p><p><strong>Example:</strong> If a default rule contains the line default valid_input = false and a custom rule that contains the line default valid_input = true is created, the Validation service will not start.</p><p><strong>Procedure</strong></p><ol><li>Connect to the terminal of the Validation pod:</li></ol><pre tabindex=0><code>$ kubectl rsh &lt;validation_pod&gt;
</code></pre><ol start=2><li>Go to the OPA policies directory for the provider:</li></ol><pre tabindex=0><code>$ cd /usr/share/opa/policies/io/konveyor/forklift/&lt;provider&gt; (1)
</code></pre><p>The explanations below refer to the callouts in the sample code above.</p><ul><li>(1) Specify vmware or ovirt.</li></ul><ol start=3><li>Search for the default policies:</li></ol><pre tabindex=0><code>$ grep -R &#34;default&#34; *
</code></pre><h2 id=retrieving-the-inventory-service-json>Retrieving the Inventory service JSON</h2><p>Follow the steps below to retrieve the Inventory service JSON by sending an Inventory service query to a virtual machine (VM). The output contains an &ldquo;input&rdquo; key, which contains the inventory attributes that are queried by the Validation service rules.</p><p>Create a validation rule based on any attribute in the &ldquo;input&rdquo; key, for example, input.snapshot.kind.</p><p><strong>Procedure</strong></p><ol><li>Retrieve the Inventory service route:</li></ol><pre tabindex=0><code>$ kubectl get route &lt;inventory_service&gt; -n konveyor-forklift
</code></pre><ol start=2><li>Retrieve the UUID of a provider:</li></ol><pre tabindex=0><code>$ GET https://&lt;inventory_service_route&gt;/providers/&lt;provider&gt; (1)
</code></pre><p>The explanations below refer to the callouts in the sample code above.</p><ul><li>(1) Allowed values for the provider are vsphere and ovirt.</li></ul><ol start=3><li>Retrieve the VMs of a provider:</li></ol><pre tabindex=0><code>$ GET https://&lt;inventory_service_route&gt;/providers/&lt;provider&gt;/&lt;UUID&gt;/vms
</code></pre><ol start=4><li>Retrieve the details of a VM:</li></ol><pre tabindex=0><code>$ GET https://&lt;inventory_service_route&gt;/providers/&lt;provider&gt;/&lt;UUID&gt;/workloads/&lt;vm&gt;
</code></pre><p>Example output:</p><pre tabindex=0><code>{
    &#34;input&#34;: {
        &#34;selfLink&#34;: &#34;providers/vsphere/c872d364-d62b-46f0-bd42-16799f40324e/workloads/vm-431&#34;,
        &#34;id&#34;: &#34;vm-431&#34;,
        &#34;parent&#34;: {
            &#34;kind&#34;: &#34;Folder&#34;,
            &#34;id&#34;: &#34;group-v22&#34;
        },
        &#34;revision&#34;: 1,
        &#34;name&#34;: &#34;iscsi-target&#34;,
        &#34;revisionValidated&#34;: 1,
        &#34;isTemplate&#34;: false,
        &#34;networks&#34;: [
            {
                &#34;kind&#34;: &#34;Network&#34;,
                &#34;id&#34;: &#34;network-31&#34;
            },
            {
                &#34;kind&#34;: &#34;Network&#34;,
                &#34;id&#34;: &#34;network-33&#34;
            }
        ],
        &#34;disks&#34;: [
            {
                &#34;key&#34;: 2000,
                &#34;file&#34;: &#34;[iSCSI_Datastore] iscsi-target/iscsi-target-000001.vmdk&#34;,
                &#34;datastore&#34;: {
                    &#34;kind&#34;: &#34;Datastore&#34;,
                    &#34;id&#34;: &#34;datastore-63&#34;
                },
                &#34;capacity&#34;: 17179869184,
                &#34;shared&#34;: false,
                &#34;rdm&#34;: false
            },
            {
                &#34;key&#34;: 2001,
                &#34;file&#34;: &#34;[iSCSI_Datastore] iscsi-target/iscsi-target_1-000001.vmdk&#34;,
                &#34;datastore&#34;: {
                    &#34;kind&#34;: &#34;Datastore&#34;,
                    &#34;id&#34;: &#34;datastore-63&#34;
                },
                &#34;capacity&#34;: 10737418240,
                &#34;shared&#34;: false,
                &#34;rdm&#34;: false
            }
        ],
        &#34;concerns&#34;: [],
        &#34;policyVersion&#34;: 5,
        &#34;uuid&#34;: &#34;42256329-8c3a-2a82-54fd-01d845a8bf49&#34;,
        &#34;firmware&#34;: &#34;bios&#34;,
        &#34;powerState&#34;: &#34;poweredOn&#34;,
        &#34;connectionState&#34;: &#34;connected&#34;,
        &#34;snapshot&#34;: {
            &#34;kind&#34;: &#34;VirtualMachineSnapshot&#34;,
            &#34;id&#34;: &#34;snapshot-3034&#34;
        },
        &#34;changeTrackingEnabled&#34;: false,
        &#34;cpuAffinity&#34;: [
            0,
            2
        ],
        &#34;cpuHotAddEnabled&#34;: true,
        &#34;cpuHotRemoveEnabled&#34;: false,
        &#34;memoryHotAddEnabled&#34;: false,
        &#34;faultToleranceEnabled&#34;: false,
        &#34;cpuCount&#34;: 2,
        &#34;coresPerSocket&#34;: 1,
        &#34;memoryMB&#34;: 2048,
        &#34;guestName&#34;: &#34;Red Hat Enterprise Linux 7 (64-bit)&#34;,
        &#34;balloonedMemory&#34;: 0,
        &#34;ipAddress&#34;: &#34;10.19.2.96&#34;,
        &#34;storageUsed&#34;: 30436770129,
        &#34;numaNodeAffinity&#34;: [
            &#34;0&#34;,
            &#34;1&#34;
        ],
        &#34;devices&#34;: [
            {
                &#34;kind&#34;: &#34;RealUSBController&#34;
            }
        ],
        &#34;host&#34;: {
            &#34;id&#34;: &#34;host-29&#34;,
            &#34;parent&#34;: {
                &#34;kind&#34;: &#34;Cluster&#34;,
                &#34;id&#34;: &#34;domain-c26&#34;
            },
            &#34;revision&#34;: 1,
            &#34;name&#34;: &#34;IP address or host name of the vCenter host or {rhv-short} Engine host&#34;,
            &#34;selfLink&#34;: &#34;providers/vsphere/c872d364-d62b-46f0-bd42-16799f40324e/hosts/host-29&#34;,
            &#34;status&#34;: &#34;green&#34;,
            &#34;inMaintenance&#34;: false,
            &#34;managementServerIp&#34;: &#34;10.19.2.96&#34;,
            &#34;thumbprint&#34;: &lt;thumbprint&gt;,
            &#34;timezone&#34;: &#34;UTC&#34;,
            &#34;cpuSockets&#34;: 2,
            &#34;cpuCores&#34;: 16,
            &#34;productName&#34;: &#34;VMware ESXi&#34;,
            &#34;productVersion&#34;: &#34;6.5.0&#34;,
            &#34;networking&#34;: {
                &#34;pNICs&#34;: [
                    {
                        &#34;key&#34;: &#34;key-vim.host.PhysicalNic-vmnic0&#34;,
                        &#34;linkSpeed&#34;: 10000
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PhysicalNic-vmnic1&#34;,
                        &#34;linkSpeed&#34;: 10000
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PhysicalNic-vmnic2&#34;,
                        &#34;linkSpeed&#34;: 10000
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PhysicalNic-vmnic3&#34;,
                        &#34;linkSpeed&#34;: 10000
                    }
                ],
                &#34;vNICs&#34;: [
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualNic-vmk2&#34;,
                        &#34;portGroup&#34;: &#34;VM_Migration&#34;,
                        &#34;dPortGroup&#34;: &#34;&#34;,
                        &#34;ipAddress&#34;: &#34;192.168.79.13&#34;,
                        &#34;subnetMask&#34;: &#34;255.255.255.0&#34;,
                        &#34;mtu&#34;: 9000
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualNic-vmk0&#34;,
                        &#34;portGroup&#34;: &#34;Management Network&#34;,
                        &#34;dPortGroup&#34;: &#34;&#34;,
                        &#34;ipAddress&#34;: &#34;10.19.2.13&#34;,
                        &#34;subnetMask&#34;: &#34;255.255.255.128&#34;,
                        &#34;mtu&#34;: 1500
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualNic-vmk1&#34;,
                        &#34;portGroup&#34;: &#34;Storage Network&#34;,
                        &#34;dPortGroup&#34;: &#34;&#34;,
                        &#34;ipAddress&#34;: &#34;172.31.2.13&#34;,
                        &#34;subnetMask&#34;: &#34;255.255.0.0&#34;,
                        &#34;mtu&#34;: 1500
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualNic-vmk3&#34;,
                        &#34;portGroup&#34;: &#34;&#34;,
                        &#34;dPortGroup&#34;: &#34;dvportgroup-48&#34;,
                        &#34;ipAddress&#34;: &#34;192.168.61.13&#34;,
                        &#34;subnetMask&#34;: &#34;255.255.255.0&#34;,
                        &#34;mtu&#34;: 1500
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualNic-vmk4&#34;,
                        &#34;portGroup&#34;: &#34;VM_DHCP_Network&#34;,
                        &#34;dPortGroup&#34;: &#34;&#34;,
                        &#34;ipAddress&#34;: &#34;10.19.2.231&#34;,
                        &#34;subnetMask&#34;: &#34;255.255.255.128&#34;,
                        &#34;mtu&#34;: 1500
                    }
                ],
                &#34;portGroups&#34;: [
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-VM Network&#34;,
                        &#34;name&#34;: &#34;VM Network&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch0&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-Management Network&#34;,
                        &#34;name&#34;: &#34;Management Network&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch0&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-VM_10G_Network&#34;,
                        &#34;name&#34;: &#34;VM_10G_Network&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch1&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-VM_Storage&#34;,
                        &#34;name&#34;: &#34;VM_Storage&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch1&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-VM_DHCP_Network&#34;,
                        &#34;name&#34;: &#34;VM_DHCP_Network&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch1&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-Storage Network&#34;,
                        &#34;name&#34;: &#34;Storage Network&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch1&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-VM_Isolated_67&#34;,
                        &#34;name&#34;: &#34;VM_Isolated_67&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch2&#34;
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.PortGroup-VM_Migration&#34;,
                        &#34;name&#34;: &#34;VM_Migration&#34;,
                        &#34;vSwitch&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch2&#34;
                    }
                ],
                &#34;switches&#34;: [
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch0&#34;,
                        &#34;name&#34;: &#34;vSwitch0&#34;,
                        &#34;portGroups&#34;: [
                            &#34;key-vim.host.PortGroup-VM Network&#34;,
                            &#34;key-vim.host.PortGroup-Management Network&#34;
                        ],
                        &#34;pNICs&#34;: [
                            &#34;key-vim.host.PhysicalNic-vmnic4&#34;
                        ]
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch1&#34;,
                        &#34;name&#34;: &#34;vSwitch1&#34;,
                        &#34;portGroups&#34;: [
                            &#34;key-vim.host.PortGroup-VM_10G_Network&#34;,
                            &#34;key-vim.host.PortGroup-VM_Storage&#34;,
                            &#34;key-vim.host.PortGroup-VM_DHCP_Network&#34;,
                            &#34;key-vim.host.PortGroup-Storage Network&#34;
                        ],
                        &#34;pNICs&#34;: [
                            &#34;key-vim.host.PhysicalNic-vmnic2&#34;,
                            &#34;key-vim.host.PhysicalNic-vmnic0&#34;
                        ]
                    },
                    {
                        &#34;key&#34;: &#34;key-vim.host.VirtualSwitch-vSwitch2&#34;,
                        &#34;name&#34;: &#34;vSwitch2&#34;,
                        &#34;portGroups&#34;: [
                            &#34;key-vim.host.PortGroup-VM_Isolated_67&#34;,
                            &#34;key-vim.host.PortGroup-VM_Migration&#34;
                        ],
                        &#34;pNICs&#34;: [
                            &#34;key-vim.host.PhysicalNic-vmnic3&#34;,
                            &#34;key-vim.host.PhysicalNic-vmnic1&#34;
                        ]
                    }
                ]
            },
            &#34;networks&#34;: [
                {
                    &#34;kind&#34;: &#34;Network&#34;,
                    &#34;id&#34;: &#34;network-31&#34;
                },
                {
                    &#34;kind&#34;: &#34;Network&#34;,
                    &#34;id&#34;: &#34;network-34&#34;
                },
                {
                    &#34;kind&#34;: &#34;Network&#34;,
                    &#34;id&#34;: &#34;network-57&#34;
                },
                {
                    &#34;kind&#34;: &#34;Network&#34;,
                    &#34;id&#34;: &#34;network-33&#34;
                },
                {
                    &#34;kind&#34;: &#34;Network&#34;,
                    &#34;id&#34;: &#34;dvportgroup-47&#34;
                }
            ],
            &#34;datastores&#34;: [
                {
                    &#34;kind&#34;: &#34;Datastore&#34;,
                    &#34;id&#34;: &#34;datastore-35&#34;
                },
                {
                    &#34;kind&#34;: &#34;Datastore&#34;,
                    &#34;id&#34;: &#34;datastore-63&#34;
                }
            ],
            &#34;vms&#34;: null,
            &#34;networkAdapters&#34;: [],
            &#34;cluster&#34;: {
                &#34;id&#34;: &#34;domain-c26&#34;,
                &#34;parent&#34;: {
                    &#34;kind&#34;: &#34;Folder&#34;,
                    &#34;id&#34;: &#34;group-h23&#34;
                },
                &#34;revision&#34;: 1,
                &#34;name&#34;: &#34;mycluster&#34;,
                &#34;selfLink&#34;: &#34;providers/vsphere/c872d364-d62b-46f0-bd42-16799f40324e/clusters/domain-c26&#34;,
                &#34;folder&#34;: &#34;group-h23&#34;,
                &#34;networks&#34;: [
                    {
                        &#34;kind&#34;: &#34;Network&#34;,
                        &#34;id&#34;: &#34;network-31&#34;
                    },
                    {
                        &#34;kind&#34;: &#34;Network&#34;,
                        &#34;id&#34;: &#34;network-34&#34;
                    },
                    {
                        &#34;kind&#34;: &#34;Network&#34;,
                        &#34;id&#34;: &#34;network-57&#34;
                    },
                    {
                        &#34;kind&#34;: &#34;Network&#34;,
                        &#34;id&#34;: &#34;network-33&#34;
                    },
                    {
                        &#34;kind&#34;: &#34;Network&#34;,
                        &#34;id&#34;: &#34;dvportgroup-47&#34;
                    }
                ],
                &#34;datastores&#34;: [
                    {
                        &#34;kind&#34;: &#34;Datastore&#34;,
                        &#34;id&#34;: &#34;datastore-35&#34;
                    },
                    {
                        &#34;kind&#34;: &#34;Datastore&#34;,
                        &#34;id&#34;: &#34;datastore-63&#34;
                    }
                ],
                &#34;hosts&#34;: [
                    {
                        &#34;kind&#34;: &#34;Host&#34;,
                        &#34;id&#34;: &#34;host-44&#34;
                    },
                    {
                        &#34;kind&#34;: &#34;Host&#34;,
                        &#34;id&#34;: &#34;host-29&#34;
                    }
                ],
                &#34;dasEnabled&#34;: false,
                &#34;dasVms&#34;: [],
                &#34;drsEnabled&#34;: true,
                &#34;drsBehavior&#34;: &#34;fullyAutomated&#34;,
                &#34;drsVms&#34;: [],
                &#34;datacenter&#34;: null
            }
        }
    }
}
</code></pre><h2 id=creating-a-validation-rule>Creating a validation rule</h2><p>Follow the steps below to create a validation rule by applying a config map custom resource (CR) containing the rule to the Validation service.</p><ul><li><p>If the rule has the same name as an existing rule, the Validation service performs an OR operation with the rules.</p></li><li><p>If the rule contradicts a default rule, the Validation service will not start.</p></li></ul><h3 id=validation-rule-example>Validation rule example</h3><p>Validation rules are based on virtual machine (VM) attributes collected by the Provider Inventory service.</p><p>For example, the VMware API uses this path to check whether a VMware VM has NUMA node affinity configured: MOR:VirtualMachine.config.extraConfig[&ldquo;numa.nodeAffinity&rdquo;].</p><p>The Provider Inventory service simplifies this configuration and returns a testable attribute with a list value:</p><pre tabindex=0><code>&#34;numaNodeAffinity&#34;: [
    &#34;0&#34;,
    &#34;1&#34;
],
</code></pre><p>Create a Rego query, based on this attribute, and add it to the forklift-validation-config config map:</p><pre tabindex=0><code>`count(input.numaNodeAffinity) != 0`
</code></pre><p><strong>Procedure</strong></p><ol><li>Create a config map CR according to the following example:</li></ol><pre tabindex=0><code>$ cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: &lt;forklift-validation-config&gt;
  namespace: konveyor-forklift
data:
  vmware_multiple_disks.rego: |-
    package &lt;provider_package&gt; (1)

    has_multiple_disks { (2)
      count(input.disks) &gt; 1
    }

    concerns[flag] {
      has_multiple_disks (3)
        flag := {
          &#34;category&#34;: &#34;&lt;Information&gt;&#34;, (4)
          &#34;label&#34;: &#34;Multiple disks detected&#34;,
          &#34;assessment&#34;: &#34;Multiple disks detected on this VM.&#34;
        }
    }
EOF
</code></pre><p>The explanations below refer to the callouts in the sample code above.</p><ul><li>(1) Specify the provider package name. Allowed values are io.konveyor.forklift.vmware for VMware and io.konveyor.forklift.ovirt for oVirt.</li><li>(2) Specify the concerns name and Rego query.</li><li>(3) Specify the concerns name and flag parameter values.</li><li>(4) Allowed values are Critical, Warning, and Information.</li></ul><ol start=2><li>Stop the Validation pod by scaling the forklift-controller deployment to 0:</li></ol><pre tabindex=0><code>$ kubectl scale -n konveyor-forklift --replicas=0 deployment/forklift-controller
</code></pre><ol start=3><li>Start the Validation pod by scaling the forklift-controller deployment to 1:</li></ol><pre tabindex=0><code>$ kubectl scale -n konveyor-forklift --replicas=1 deployment/forklift-controller
</code></pre><ol start=4><li>Check the Validation pod log to verify that the pod started:</li></ol><pre tabindex=0><code>$ kubectl logs -f &lt;validation_pod&gt;
</code></pre><p>If the custom rule conflicts with a default rule, the Validation pod will not start.</p><ol start=5><li>Remove the source provider:</li></ol><pre tabindex=0><code>$ kubectl delete provider &lt;provider&gt; -n konveyor-forklift
</code></pre><ol start=6><li>Add the source provider to apply the new rule:</li></ol><pre tabindex=0><code>$ cat &lt;&lt; EOF | kubectl apply -f -
apiVersion: forklift.konveyor.io/v1beta1
kind: Provider
metadata:
  name: &lt;provider&gt;
  namespace: konveyor-forklift
spec:
  type: &lt;provider_type&gt; (1)
  url: &lt;api_end_point&gt; (2)
  secret:
    name: &lt;secret&gt; (3)
    namespace: konveyor-forklift
EOF
</code></pre><p>The explanations below refer to the callouts in the sample code above.</p><ul><li>(1) Allowed values are ovirt and vsphere.</li><li>(2) Specify the API end point URL, for example, https://&lt;vCenter_host>/sdk for vSphere or https://&lt;{rhv-short}_engine_host>/ovirt-engine/api/ for oVirt.</li><li>(3) Specify the name of the provider Secret CR.</li></ul><blockquote><p><strong>Important:</strong> Update the rules version after creating a custom rule so that the Inventory service detects the changes and validates the VMs.</p></blockquote><h2 id=updating-the-inventory-rules-version>Updating the inventory rules version</h2><p>Follow the steps below to update the inventory rules version each time the rules are updated so that the Provider Inventory service detects the changes and triggers the Validation service.</p><p>The rules version is recorded in a rules_version.rego file for each provider.</p><p><strong>Procedure</strong></p><ol><li>Retrieve the current rules version:</li></ol><pre tabindex=0><code>$ GET https://forklift-validation/v1/data/io/konveyor/forklift/&lt;provider&gt;/rules_version (1)
</code></pre><p>Example output:</p><pre tabindex=0><code>{
   &#34;result&#34;: {
       &#34;rules_version&#34;: 5
   }
}
</code></pre><ol start=2><li>Connect to the terminal of the Validation pod:</li></ol><pre tabindex=0><code>$ kubectl rsh &lt;validation_pod&gt;
</code></pre><ol start=3><li><p>Update the rules version in the <strong>/usr/share/opa/policies/io/konveyor/forklift//rules_version.rego</strong> file.</p></li><li><p>Log out of the Validation pod terminal.</p></li><li><p>Verify the updated rules version:</p></li></ol><pre tabindex=0><code>$ GET https://forklift-validation/v1/data/io/konveyor/forklift/&lt;provider&gt;/rules_version (1)
Example output
{
   &#34;result&#34;: {
       &#34;rules_version&#34;: 6
   }
}
</code></pre><p><a href=https://github.com/konveyor/konveyor.github.io/blob/main/content/Forklift/MigratingVMs/advancedmigrate.md>Source</a></p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js></script>
<script src=/js/perfect-scrollbar.min.js></script>
<script src=/js/perfect-scrollbar.jquery.min.js></script>
<script src=/js/jquery.sticky.js></script>
<script src=/js/featherlight.min.js></script>
<script src=/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js></script>
<script src=/js/learn.js></script>
<script src=/js/hugo-learn.js></script>
<script src=https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0})</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TKPDMS3" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript></body></html>